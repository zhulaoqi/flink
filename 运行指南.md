# Flink项目运行指南

## 一、环境准备

### 1. Docker环境检查

确认Flink集群已经启动：

```bash
docker ps | grep flink
```

应该看到：

- flink-jobmanager（容器运行中）
- flink-taskmanager（容器运行中）

访问Flink WebUI：http://localhost:8081

### 2. 项目编译

```bash
cd /Users/zhujinqi/Documents/learn/bigdata/flink
mvn clean package -DskipTests
```

## 二、运行方式

### 方式一：IDE本地运行（推荐用于学习）

#### 1. 基础API演示

```java
// 运行类
com.kinch.flink.basics.DataStreamBasicsDemo

// 功能
-Map、Filter、FlatMap转换
-KeyBy分组
-聚合操作
-Union和Connect
```

#### 2. 窗口操作演示

```java
// 运行类
com.kinch.flink.window.WindowBasicsDemo

// 功能
-滚动窗口
-滑动窗口
-会话窗口
-计数窗口
-窗口函数
```

#### 3. 水位线演示

```java
// 运行类
com.kinch.flink.watermark.WatermarkDemo

// 功能
-乱序数据处理
-水位线生成
-延迟数据处理
```

#### 4. 状态管理演示

```java
// 运行类
com.kinch.flink.state.StateManagementDemo

// 功能
-ValueState使用
-ListState使用
-MapState使用
-ReducingState使用
-AggregatingState使用
-
State TTL配置
```

#### 5. Checkpoint演示

```java
// 运行类
com.kinch.flink.checkpoint.CheckpointDemo

// 功能
-Checkpoint配置
-StateBackend选择
-重启策略
-容错机制
```

#### 6. ProcessFunction演示

```java
// 运行类
com.kinch.flink.processfunction.ProcessFunctionDemo

// 功能
-温度持续上升检测
-超时检测
-定时器使用
-异常检测
```

#### 7. 侧输出流演示

```java
// 运行类
com.kinch.flink.sideoutput.SideOutputDemo

// 功能
-数据分流
-多级告警
-数据质量监控
```

#### 8. 异步IO演示

```java
// 运行类
com.kinch.flink.asyncio.AsyncIODemo

// 功能
-异步数据库查询
-异步HTTP请求
-异步缓存查询
```

#### 9. Table API演示

```java
// 运行类
com.kinch.flink.table.TableAPIDemo

// 功能
-
Table API操作
-SQL查询
-窗口聚合
-TopN查询
-Join操作
```

#### 10. CEP演示

```java
// 运行类
com.kinch.flink.cep.CEPDemo

// 功能
-温度持续上升检测
-订单超时检测
-登录失败检测
-复杂模式匹配
```

#### 11. Kafka连接器演示

```java
// 运行类
com.kinch.flink.connector.KafkaConnectorDemo

// 前置条件
需要Kafka环境（可以先注释掉相关代码学习理论）

        // 功能
        -KafkaSource配置
-KafkaSink配置
-Exactly-Once语义
-性能优化
```

#### 12. JDBC连接器演示

```java
// 运行类
com.kinch.flink.connector.JDBCConnectorDemo

// 前置条件
需要MySQL环境（可以先注释掉相关代码学习理论）

        // 功能
        -JdbcSink配置
-批量写入
-UPSERT模式
-连接池优化
```

#### 13. 序列化演示

```java
// 运行类
com.kinch.flink.serialization.SerializationDemo

// 功能
-POJO序列化
-JSON序列化
-自定义序列化
-性能对比
```

### 方式二：提交到Flink集群（推荐用于生产）

#### 1. 编译打包

```bash
mvn clean package -DskipTests
```

#### 2. 提交任务到集群

```bash
# 基础API示例
docker exec -it flink-jobmanager flink run \
  -c com.kinch.flink.basics.DataStreamBasicsDemo \
  /path/to/flink-0.0.1-SNAPSHOT.jar

# 窗口操作示例
docker exec -it flink-jobmanager flink run \
  -c com.kinch.flink.window.WindowBasicsDemo \
  /path/to/flink-0.0.1-SNAPSHOT.jar

# 其他示例类似...
```

#### 3. 通过WebUI提交

1. 访问：http://localhost:8081
2. 点击"Submit New Job"
3. 上传jar包：target/flink-0.0.1-SNAPSHOT.jar
4. 选择入口类（Entry Class）
5. 点击"Submit"

## 三、学习顺序建议

### 第1天：基础概念

1. ✅ DataStreamBasicsDemo - 学习基础API
2. ✅ WindowBasicsDemo - 理解窗口概念
3. ✅ WatermarkDemo - 掌握时间和水位线

**学习重点：**

- 理解DataStream的概念
- 掌握Map、Filter等基础操作
- 理解窗口的工作原理
- 理解事件时间和处理时间的区别

### 第2天：状态和容错

4. ✅ StateManagementDemo - 学习状态管理
5. ✅ CheckpointDemo - 理解容错机制
6. ✅ ProcessFunctionDemo - 掌握底层API

**学习重点：**

- 理解Keyed State的使用
- 掌握State TTL的配置
- 理解Checkpoint的原理
- 学会使用定时器

### 第3天：高级特性

7. ✅ SideOutputDemo - 学习数据分流
8. ✅ AsyncIODemo - 理解异步IO
9. ✅ TableAPIDemo - 学习Table API

**学习重点：**

- 掌握侧输出流的使用场景
- 理解异步IO的性能优势
- 学习SQL的使用

### 第4天：实战应用

10. ✅ CEPDemo - 学习复杂事件处理
11. ✅ KafkaConnectorDemo - 学习Kafka集成
12. ✅ JDBCConnectorDemo - 学习数据库集成
13. ✅ SerializationDemo - 学习序列化

**学习重点：**

- 掌握CEP的模式匹配
- 理解Exactly-Once语义
- 掌握连接器的使用
- 理解序列化的重要性

## 四、实战练习建议

### 练习1：实时温度监控系统

**需求：**

- 实时监控传感器温度
- 温度超过30度告警
- 统计每分钟平均温度
- 检测温度持续上升

**涉及知识点：**

- DataStream基础操作
- 窗口聚合
- ProcessFunction
- CEP模式匹配

### 练习2：用户行为分析

**需求：**

- 统计每小时PV/UV
- 实时计算热门商品Top10
- 检测异常用户行为
- 用户流失预警

**涉及知识点：**

- 窗口操作
- 状态管理
- TopN查询
- CEP

### 练习3：订单实时分析

**需求：**

- 订单超时检测
- 实时GMV统计
- 订单状态变化追踪
- 异常订单识别

**涉及知识点：**

- ProcessFunction定时器
- 状态管理
- CEP
- 侧输出流

## 五、常见问题解决

### 问题1：找不到主类

```
Error: Could not find or load main class
```

**解决方案：**

- 确认pom.xml中的依赖正确
- 运行mvn clean package重新编译
- 检查类路径是否正确

### 问题2：端口冲突

```
Address already in use: bind
```

**解决方案：**

```bash
# 检查端口占用
netstat -ano | findstr 8081

# 或修改docker-compose.yml中的端口映射
```

### 问题3：内存不足

```
java.lang.OutOfMemoryError: Java heap space
```

**解决方案：**

- 增加JVM堆内存：-Xmx2048m
- 减小并行度
- 优化状态使用

### 问题4：Checkpoint失败

```
Checkpoint expired before completing
```

**解决方案：**

- 增加Checkpoint超时时间
- 优化算子处理速度
- 检查StateBackend配置

## 六、监控和调试

### 1. Flink WebUI

访问：http://localhost:8081

**查看内容：**

- Running Jobs：运行中的任务
- Completed Jobs：已完成的任务
- Task Managers：TaskManager状态
- Job Manager：JobManager日志
- Checkpoint：Checkpoint统计

### 2. 日志查看

```bash
# 查看JobManager日志
docker logs flink-jobmanager

# 查看TaskManager日志
docker logs flink-taskmanager

# 实时查看日志
docker logs -f flink-taskmanager
```

### 3. 指标监控

- Checkpoint Duration：Checkpoint耗时
- State Size：状态大小
- Records Sent/Received：数据吞吐量
- Backpressure：反压情况

## 七、性能调优建议

### 1. 并行度设置

```java
// 全局并行度
env.setParallelism(4);

// 算子级并行度
stream.

map(...).

setParallelism(8);
```

**建议：**

- 并行度 = CPU核心数 * 2
- Source并行度 = Kafka分区数
- 计算密集型算子可以增加并行度

### 2. 内存配置

```yaml
# taskmanager配置
taskmanager.memory.process.size: 2048m
taskmanager.numberOfTaskSlots: 4
```

### 3. Checkpoint优化

```java
// 增量Checkpoint（RocksDB）
env.setStateBackend(new EmbeddedRocksDBStateBackend());

// Checkpoint间隔
        env.

enableCheckpointing(60000);  // 1分钟

// 最小间隔
checkpointConfig.

setMinPauseBetweenCheckpoints(30000);
```

### 4. 网络优化

```java
// 启用对象重用
env.getConfig().

enableObjectReuse();

// 调整缓冲区大小
// taskmanager.network.memory.fraction: 0.1
```

## 八、下一步学习

### 1. 源码阅读

- Flink架构设计
- Checkpoint机制
- 水位线传播
- 状态管理

### 2. 进阶主题

- Flink SQL深入
- 自定义连接器
- 自定义Function
- Metrics和监控

### 3. 生产实践

- 大规模部署
- 性能调优
- 故障排查
- 升级迁移

---

**祝学习顺利！如有问题，欢迎交流讨论。**

